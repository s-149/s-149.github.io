<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <title>Week Generator</title>
    <meta content="Week Generator" name="description" />
    <meta content="Week Generator" name="keywords" />
    <meta name="author" content="Mr.S-149" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="assets-blitz/img/logo/logo.jpg" rel="icon" />
    <link href="assets-blitz/img/apple-touch-icon.png" rel="apple-touch-icon" />

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body>
    <div class="container py-4">
        <h2 class="mb-4">Week Generator</h2>

        <div class="row align-items-end g-3">
            <div class="col-md-4">
                <label for="endDate" class="form-label">End Date:</label>
                <input type="date" id="endDate" class="form-control" />
            </div>

            <div class="col-md-4">
                <label for="jumlahWeekYear" class="form-label">Week Year Amount:</label>
                <input type="number" id="jumlahWeekYear" min="1" placeholder="Masukkan jumlah week" class="form-control" />
            </div>

            <div class="col-md-4 d-grid">
                <button onclick="generateWeeks()" class="btn btn-primary w-100">Generate Weeks</button>
            </div>
        </div>

        <div id="infoPenyesuaian" class="mt-3 text-primary" style="white-space: pre-line;"></div>

        <!-- Tombol Copy -->
        <div class="d-flex justify-content-end mt-3">
            <button id="copyBtn" class="btn btn-secondary btn-sm" style="display:none;" data-clipboard-target="#hasil">Copy</button>
        </div>

        <div id="hasil" class="mt-2"></div>
    </div>

    <!-- Toast notif -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="toastNotif" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="toastBody">
                    Berhasil copy hasil ke clipboard!
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Clipboard.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script>

    <script>
        function generateWeeks() {
            const endInput = document.getElementById('endDate').value;
            const jumlahWeekYear = parseInt(document.getElementById('jumlahWeekYear').value);

            if (!endInput || !jumlahWeekYear) {
                alert('Isi tanggal akhir dan jumlah Week Year!');
                return;
            }

            let endDate = new Date(endInput);
            let infoPenyesuaian = '';

            // Penyesuaian tanggal akhir ke Minggu
            let endDay = endDate.getDay();
            if (endDay !== 0) {
                endDate.setDate(endDate.getDate() + (7 - endDay));
                infoPenyesuaian += `Tanggal akhir disesuaikan ke hari Minggu: ${endDate.toISOString().slice(0, 10)}\n`;
            }

            // Hitung tanggal mulai berdasarkan jumlah minggu
            let startDate = new Date(endDate);
            startDate.setDate(endDate.getDate() - (7 * (jumlahWeekYear - 1)) - 6); // mundur sekian minggu + 6 hari supaya pas Senin

            // Penyesuaian tanggal mulai ke Senin
            let startDay = startDate.getDay();
            if (startDay !== 1) {
                startDate.setDate(startDate.getDate() - (startDay === 0 ? 6 : (startDay - 1)));
                infoPenyesuaian += `Tanggal mulai disesuaikan ke hari Senin: ${startDate.toISOString().slice(0, 10)}`;
            }

            document.getElementById('infoPenyesuaian').innerText = infoPenyesuaian;

            let current = new Date(startDate);
            let data = [];

            let weekCountInMonth = 1;
            let currentMonth = current.getMonth();
            let currentYear = current.getFullYear();

            while (current <= endDate) {
                let startOfWeek = new Date(current);
                let endOfWeek = new Date(current);
                endOfWeek.setDate(current.getDate() + 6);

                // Cek bulan, reset week count tiap bulan
                if (startOfWeek.getMonth() !== currentMonth) {
                    weekCountInMonth = 1;
                    currentMonth = startOfWeek.getMonth();
                    currentYear = startOfWeek.getFullYear();
                }

                data.push({
                    year: currentYear,
                    week: weekCountInMonth,
                    start: startOfWeek.toISOString().slice(0, 10),
                    end: endOfWeek.toISOString().slice(0, 10),
                });

                current.setDate(current.getDate() + 7);
                weekCountInMonth++;
            }

            // Urutkan dari tanggal terbaru ke lama
            data.sort((a, b) => new Date(b.start) - new Date(a.start));

            // Assign Week Year: MULAI dari TOTAL ke 1
            let totalWeeks = data.length;
            data = data.map((row, index) => ({
                weekYear: totalWeeks - index,
                ...row,
            }));

            let hasilHTML = `<table class="table table-bordered table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>Year</th>
                        <th>Week (Year)</th>
                        <th>Week (Month)</th>
                        <th>Periode</th>
                    </tr>
                </thead><tbody>`;

            data.forEach((row) => {
                hasilHTML += `<tr>
                    <td>${row.year}</td>
                    <td>${row.weekYear}</td>
                    <td>${row.week}</td>
                    <td>${row.start} - ${row.end}</td>
                </tr>`;
            });

            hasilHTML += '</tbody></table>';
            document.getElementById('hasil').innerHTML = hasilHTML;

            // Tampilkan tombol copy
            document.getElementById('copyBtn').style.display = 'inline-block';
        }

        // Init Clipboard.js
        const clipboard = new ClipboardJS('#copyBtn');

        // Bootstrap Toast instance
        const toastEl = document.getElementById('toastNotif');
        const toast = new bootstrap.Toast(toastEl);

        clipboard.on('success', function(e) {
            // show success toast
            document.getElementById('toastBody').innerText = 'Berhasil copy hasil ke clipboard!';
            toastEl.classList.remove('text-bg-danger');
            toastEl.classList.add('text-bg-success');
            toast.show();
            e.clearSelection();
        });

        clipboard.on('error', function(e) {
            // show error toast
            document.getElementById('toastBody').innerText = 'Gagal copy hasil.';
            toastEl.classList.remove('text-bg-success');
            toastEl.classList.add('text-bg-danger');
            toast.show();
        });
    </script>
</body>

</html>